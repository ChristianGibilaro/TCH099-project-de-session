<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Human Verification</title>
    <link rel="icon" href="ressources/Final/Main/logo.png" type="image/png">
    <link rel="stylesheet" href="Styles/Demonstrateur.css">
    <link rel="stylesheet" href="Styles/Index.css">
    <script src="https://www.google.com/recaptcha/api.js?render=6LcANxErAAAAAJG-TrKVTRQXnM6dRM9vOeiGJkpx"></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="Scripts/globalVars.js"></script>
    <script src="Scripts/mainScript.js"></script>
</head>

<script>
    var API = new mainScript("Index");
    // Utility function to get URL parameter by name
    function getUrlParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
    }
    // Determine autoRedirect based on "redirect" URL parameter
    // autoRedirect = true by default, unless "?redirect=false"
    var autoRedirect = true;
    const redirectParam = getUrlParam('redirect');
    if (redirectParam && redirectParam.toLowerCase() === 'false') {
        autoRedirect = false;
    }
</script>

<body class="verification-page">
    <div class="verification-container">
        <h1>Human Verification</h1>
        <p>Please verify that you are human to continue.</p>
        
        <button id="verifyHuman" class="verify-button">Verify Human</button>
        <button id="simulateBot" class="simulate-button">Simulate Bot</button>

        <div id="errorMessage" class="verification-error"></div>
        <div id="successMessage" class="verification-success"></div>

        <div id="captchaV2Container" class="captcha-container">
            <p>Additional verification required:</p>
            <div 
                class="g-recaptcha verification-recaptcha" 
                data-sitekey="6LfCPRErAAAAAODzRm79dbFTUtCiIPmZSn7vs1Jt" 
                data-callback="onCaptchaV2Success"
            ></div>
        </div>
    </div>

    <script>
        const errorMessageElement = document.getElementById('errorMessage');
        const successMessageElement = document.getElementById('successMessage');
        const verifyButton = document.getElementById('verifyHuman');
        const captchaV2Container = document.getElementById('captchaV2Container');

        function showMessage(element, message, duration = 5000) {
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, duration);
        }

        function showError(message) {
            showMessage(errorMessageElement, message);
        }

        function showSuccess(message) {
            showMessage(successMessageElement, message);
        }

        function setLoading(isLoading) {
            verifyButton.disabled = isLoading;
            verifyButton.classList.toggle('loading', isLoading);
            verifyButton.textContent = isLoading ? 'Verifying...' : 'Verify Human';
        }

        async function verifyHuman(API) {
            setLoading(true);
            captchaV2Container.style.display = 'none';
            
            try {
                await new Promise(resolve => grecaptcha.ready(resolve));
                
                const token = await grecaptcha.execute('6LcANxErAAAAAJG-TrKVTRQXnM6dRM9vOeiGJkpx', {
                    action: 'verify'
                });

                const result = await API.verifyWithServer(token);
                console.log('Verification result:', result);

                if (result.success) {
                    if (result.score >= 0.5) {
                        // Redirect immediately if verification is good
                        window.location.href = 'Main.html';
                        return;
                    } else {
                        showError('Additional verification required');
                        captchaV2Container.style.display = 'block';
                    }
                } else if (result.needsCaptchaV2) {
                    captchaV2Container.style.display = 'block';
                }
            } catch (error) {
                showError(`Verification failed: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        function onCaptchaV2Success(token) {
            // Redirect immediately after additional verification
            window.location.href = 'Main.html';
        }

        // Automatically verify and redirect if verification is good (no need for button click)
        document.addEventListener("DOMContentLoaded", async () => {
            if (typeof autoRedirect !== "undefined" && autoRedirect) {
                setLoading(true);
                captchaV2Container.style.display = 'none';
                try {
                    await new Promise(resolve => grecaptcha.ready(resolve));
                    const token = await grecaptcha.execute('6LcANxErAAAAAJG-TrKVTRQXnM6dRM9vOeiGJkpx', {
                        action: 'verify'
                    });
                    const result = await API.verifyWithServer(token);
                    console.log('Auto-verification result:', result);

                    if (result.success && result.score >= 0.5) {
                        window.location.href = 'Main.html';
                        return;
                    }
                    // If verification fails, show interface as fallback
                    setLoading(false);
                } catch (error) {
                    // If auto-verification fails, show interface as fallback
                    setLoading(false);
                }
            }
        });

        document.getElementById('verifyHuman').addEventListener('click', () => {verifyHuman(API);});
        document.getElementById('simulateBot').addEventListener('click', () => {API.simulateBot();});
    </script>
</body>
</html>