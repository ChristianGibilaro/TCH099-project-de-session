<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Activity</title>
  <link rel="icon" href="ressources/Final/Main/logo.png" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="Scripts/animationScript.js" defer></script>
  <script src="Scripts/ElementCreator.js"></script>
  <script src="Scripts/globalVars.js"></script>
  <script src="Scripts/mainScript.js"></script>

  <link rel="stylesheet" href="Styles/normalize.css">
  <link rel="stylesheet" href="Styles/Demonstrateur.css">

</head>

<script>
  var creator = new ElementCreator(document.title);
  var API = new mainScript(document.title);
</script>

<body>
  <!------------------------------------------------ SECTION Î© - MENU ---------------------------------------------->
  <header onclick="toggleMenu()">
    <script>
      document.write(creator.PrefabMenu);
    </script>
  </header>
  <div id="dimmer" onclick="toggleMenu()"></div>

  <div id="contenu" style="height: 100%;">

    <div id="head">
      <script>
        document.write(creator.CreateHero("ressources/Final/Main/moonDarkSign.png", "ressources/Commun/logo_example.png"));
      </script>
    </div>

    <div class="barre-filtres" id="in1">
      <script>
        async function fetchFilterOptions(filterType, id,parent,placeholder) {
          const response = await fetch(`https://api.lunarcovenant.com/api/filter/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ "filterType": filterType })
          });
          const data = await response.json();
          if (!data.elements || !Array.isArray(data.elements)) return [[], []];

          const names = ["--Clear--"];
          names.push(...data.elements.map(e => e.Name));
          const ids = data.elements.map(e => e.ID);
          console.log(names, ids);
          parent.append(creator.CreateFilterTextbox(names,placeholder));
          return [names, ids];
        }   

        const positionFilter = fetchFilterOptions('PositionFilter',1,document.getElementById("in1"),"Position");
        const typeFilter =  fetchFilterOptions('TypeFilter',1,document.getElementById("in1"),"Type");
        const languageFilter =  fetchFilterOptions('LanguageFilter',1,document.getElementById("in1"),"Language");
        const environmentFilter =  fetchFilterOptions('EnvironmentFilter',1,document.getElementById("in1"),"Environment");
        

        // Removed initializePagination call (it does not exist)
        
      </script>

      <button class="btn-connexion" id="filter-button" onclick="toggleFilter()">Filter</button>
    </div>

    <div id="fatherland" class="contenu-onglet">
      <!-- Fixed id: removed extra space -->
      <div class="page-content" id="page-content-container" style="height: 100%;">
        <div class="pagination" id="pagination-container">
          <button class="prev-page">&lt; Previous</button>
          <button class="next-page">Next &gt;</button>
        </div>
      </div>
    </div>

    <script>
      // Only declare these variables ONCE
      const PAGE_SIZE = 10;
      let totalActivities = 0;
      let PAgesd = 1;
      let paged = 1;

      async function fetchActivityCount() {
  const response = await fetch('https://api.lunarcovenant.com/api/activity/count', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
            //environmentID:1
          })
  });
  const data = await response.json();
  return data.count || 0;
}

      async function fetchActivitiesPage(page) {
        const offset = (page - 1) * PAGE_SIZE;
        const response = await fetch('https://api.lunarcovenant.com/api/activity/all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            limit: PAGE_SIZE,
            start: offset,
            fields: [
              "ID", "Title", "Main_Img", "Description", "Logo_Img", "Point_Value",
              "Word_4_Player", "Word_4_Teammate", "Word_4_Playing",
              "Main_Color", "Second_Color", "Friend_Main_Color", "Friend_Second_Color"
            ],
            activityDataFields: [
              "Team_Count", "QuickTeam_Count", "Player_Count", "Active_Player_Count"
            ]
          })
        });
        const data = await response.json();
        const activities =
          Array.isArray(data.activities) ? data.activities
            : Array.isArray(data.data) ? data.data
              : Array.isArray(data) ? data
                : [];
        return activities.map(item => ({
          ...(item.activity || {}),
          ...(item.activityData && typeof item.activityData === "object" ? item.activityData : {})
        }));
      }

      function renderActivityList(activities) {
        return creator.superScrollableList({
          mode: "post",
          items: activities,
          width: "100%",
          height: "100%",
          renderItem: (activity, idx) => {
            const playerCount = activity.Player_Count ?? activity.player_count ?? 0;
            const word4player = activity.Word_4_Player || "player";
            const teamCount = activity.Team_Count ?? activity.team_count ?? "";
            const activePlayerCount = activity.Active_Player_Count ?? activity.active_player_count ?? "";
            const activityId = activity.ID || activity.Id || activity.id || "";

            let statBlock = `
              <div style="padding:4px 0 12px 0;text-align:left;min-width:90px;font-size:0.95em;">
                <div><b>${playerCount}</b> ${word4player}</div>
                <div><b>${teamCount||"-"}</b> Teams</div>
                <div><b>${activePlayerCount||"-"}</b> active</div>
                <div style="color:var(--accent2);font-size:0.9em;">${activity.Point_Value ? `Points: ${activity.Point_Value}` : ""}</div>
              </div>
            `;

            let mainImg = `
              <div style="position:relative;width:100%;overflow:hidden;border-radius:12px;">
                <img src="${activity.Main_Img || ""}" style="width:100%;display:block;object-fit:cover;max-height:180px;filter:brightness(0.92);">
                ${activity.Logo_Img ? `
                  <img src="${activity.Logo_Img}" style="position:absolute;top:0px;left:0px;width:100%;height:100%;object-fit:contain;background:transparent;border-radius:8px;">
                ` : ""}
              </div>
            `;

            let title = `
              <div style="text-align:center;font-weight:bold;font-size:1.2em;margin:12px 0 6px 0;color:var(--accent2);">
                ${activity.Title || ""}
              </div>
            `;

            let desc = `
              <div style="padding:4px 0 0 0;white-space:pre-line;font-size:1em;">${activity.Description || ""}</div>
            `;

            return `
              <div class="activity-card" 
                   style="background:var(--bg-dark2);border-radius:14px;box-shadow:var(--shadow);margin-bottom:20px;overflow:hidden;cursor:pointer;transition:box-shadow 0.15s;"
                   onclick="window.location.href='Activity.html?id=${encodeURIComponent(activityId)}'">
                ${mainImg}
                <div style="display:flex;gap:18px;padding:14px 14px 10px 14px;">
                  <div style="flex:0 0 90px;display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-start;">
                    ${statBlock}
                  </div>
                  <div style="flex:1;min-width:0;">
                    ${title}
                    ${desc}
                  </div>
                </div>
              </div>
            `;
          }
        });
      }

      async function renderPages() {
  totalActivities = await fetchActivityCount();
  PAgesd = Math.ceil(totalActivities / PAGE_SIZE);

  const pageContent = document.querySelector('#page-content-container');
  // Pagination container will be filled later
  pageContent.innerHTML = `<div class="pagination" id="pagination-container"></div>`;

  // Create all page containers
  const pageDivs = [];
  for (let i = 1; i <= PAgesd; i++) {
    const div = document.createElement('div');
    div.className = 'page-item' + (i === 1 ? ' active' : '');
    pageContent.appendChild(div);
    pageDivs.push(div);
  }

  // Fetch and fill each page with its activities
  for (let i = 1; i <= PAgesd; i++) {
    const activities = await fetchActivitiesPage(i);
    pageDivs[i - 1].innerHTML = '';
    pageDivs[i - 1].append(renderActivityList(activities));
  }

  // Setup pagination buttons (including page numbers)
  renderPaginationButtons();
}

function renderPaginationButtons() {
  const container = document.getElementById('pagination-container');
  container.innerHTML = `
    <button class="prev-page">&lt; Previous</button>
    <span class="page-numbers"></span>
    <button class="next-page">Next &gt;</button>
  `;

  const pageNumbers = container.querySelector('.page-numbers');
  pageNumbers.innerHTML = '';
  for (let i = 1; i <= PAgesd; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = 'page-btn' + (i === paged ? ' active' : '');
    btn.onclick = () => {
      changePage(i);
      // Update active class on all page buttons
      const allBtns = container.querySelectorAll('.page-btn');
      allBtns.forEach((b, idx) => {
        if (idx === i - 1) {
          b.classList.add('active');
        } else {
          b.classList.remove('active');
        }
      });
    };
    pageNumbers.appendChild(btn);
  }

  // Also update active class when using prev/next
  container.querySelector('.prev-page').onclick = () => {
    changePage(paged - 1);
    updatePageBtnActive();
  };
  container.querySelector('.next-page').onclick = () => {
    changePage(paged + 1);
    updatePageBtnActive();
  };

  // Helper to update active class
  function updatePageBtnActive() {
    const allBtns = container.querySelectorAll('.page-btn');
    allBtns.forEach((b, idx) => {
      if (idx === paged - 1) {
        b.classList.add('active');
      } else {
        b.classList.remove('active');
      }
    });
  }
  // Initial update
  updatePageBtnActive();
}

async function loadPage(page) {
  if (page < 1 || page > PAgesd) return;
  paged = page;
  const pageContent = document.querySelector('#page-content-container');
  const pageItems = pageContent.querySelectorAll('.page-item');
  pageItems.forEach((item, idx) => item.classList.toggle('active', idx === page - 1));
  renderPaginationButtons();
}

function changePage(page) {
  if (page < 1 || page > PAgesd) return;
  loadPage(page);
}

      async function loadPage(page) {
        if (page < 1 || page > PAgesd) return;
        paged = page;
        const pageContent = document.querySelector('#page-content-container');
        const pageItems = pageContent.querySelectorAll('.page-item');
        pageItems.forEach((item, idx) => item.classList.toggle('active', idx === page - 1));

        const activities = await fetchActivitiesPage(page);
        pageItems[page - 1].innerHTML = "";
        pageItems[page - 1].append(renderActivityList(activities));
      }

      function changePage(page) {
        if (page < 1 || page > PAgesd) return;
        loadPage(page);
      }

      window.addEventListener("load", renderPages);
    </script>

  </div>

</body>

</html>