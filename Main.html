<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Home</title>
  <link rel="icon" href="ressources/Final/Main/logo.png" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <script src="Scripts/animationScript.js" defer></script>
  <script src="Scripts/ElementCreator.js"></script>
  <script src="Scripts/globalVars.js"></script>
  <script src="Scripts/mainScript.js"></script>

  <link rel="stylesheet" href="Styles/normalize.css">
  <link rel="stylesheet" href="Styles/Demonstrateur.css">

</head>

<script>
  var creator = new ElementCreator(document.title);
  var API = new mainScript(document.title);
  console.log(document.title);
  // ---------------------------------------------- LOCAL DATA -------------------------------------------
  const SiteDesc = '<strong> Welcome to Lunar Convenant </strong> <br>\
  Please observe the following <a href="#" > rule (Need to create a page for it) </a>.<br>\
  For Instruction and Assistance, go to our <a href="#" > F.A.Q (Need to create a page for it) </a><br>\
  <br>\
  Your Teammates away you!';
  
  // ---------------------------------------------- API DATA ----------------------------------------------
  const SiteStats = '<strong> 12 402</strong> Users<br>\
  <strong> 66</strong> Activities<br>\
  <strong> 152 </strong> Teams<br>';
</script>

<body>
  <!------------------------------------------------ SECTION Î© - MENU ---------------------------------------------->
  <header onclick="toggleMenu()">
    <script>
      document.write(creator.PrefabMenu);
    </script>
  </header>
  <div id="dimmer" onclick="toggleMenu()"></div>

  <!------------------------------------------------ SECTION 0 - ONGLETS ---------------------------------------------->
  <div id="contenu">

    <div id="head">
      <script>
        document.write(creator.CreateHero("ressources/Final/Main/moonDarkSign.png", "ressources/Commun/logo_example.png"));
      </script>

      <script>
        document.write(creator.CreateDesc(SiteDesc, SiteStats));
      </script>
    </div>
    <div id="fatherland">
      <script>

  let _searchToken = 0;
  const searchContainer = `<div class="search-bar-details-wrapper">
      <div class="search-container">
          <input type="text" class="search-input" placeholder="Search...">
          <div id="search-results-dropdown" class="search-results-dropdown"></div>
      </div>
      <div id="search-details-box" class="search-details-box"></div>
  </div>`;

  const searchPageHTML = `<div class="search-page">
      ${searchContainer}
  </div>`;

  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = searchPageHTML;
  const searchPageDiv = tempDiv.firstChild;
  const searchInputBox = searchPageDiv.querySelector('.search-input');
  const resultsDropdown = searchPageDiv.querySelector('#search-results-dropdown');
  const detailsBox = searchPageDiv.querySelector('#search-details-box');

  // Helper to render user details
  async function showActivityDetails(activityId) {
    detailsBox.innerHTML = '<div class="loading">Loading activity...</div>';
    try {
      const res = await fetch(`http://localhost:9999/api/activity/id/${activityId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          fields: [
            "Title", "Main_Img", "Description", "Logo_Img", "Point_Value",
            "Word_4_Player", "Word_4_Teammate", "Word_4_Playing",
            "Main_Color", "Second_Color", "Friend_Main_Color", "Friend_Second_Color"
          ],
          activityDataFields: [
            "Team_Count", "QuickTeam_Count", "Player_Count", "Active_Player_Count"
          ],
          levelFields: ["Name"],
          filterFields: ["PositionFilterID"]
        })
      });
      const result = await res.json();
      if (result.success && result.data && result.data.activity) {
        const a = result.data.activity;
        const d = result.data.activityData || {};
        detailsBox.innerHTML = `
          <div class="details-content activity-details">
            <div class="activity-image-wrapper">
              <img src="${a.Main_Img}" alt="Main" class="main-img-activity">
              ${a.Logo_Img ? `<img src="${a.Logo_Img}" alt="Logo" class="logo-img-activity">` : ""}
            </div>
            <div class="activity-info-section">
              <div class="title">${a.Title}</div>
              <div class="desc">${a.Description || ""}</div>
            </div>
            <div class="activity-stats-section">
              <div class="activity-stat-row"><strong>${d.Player_Count || 0}</strong> ${a.Word_4_Player || ""}</div>
              <div class="activity-stat-row"><strong>${d.Active_Player_Count || 0}</strong> ${a.Word_4_Playing || ""}</div>
              <div class="activity-stat-row"><strong>${d.Team_Count || 0}</strong> Teams</div>
            </div>
          </div>
        `;
      } else {
        detailsBox.innerHTML = '<div class="error">Activity not found.</div>';
      }
    } catch {
      detailsBox.innerHTML = '<div class="error">Error loading activity.</div>';
    }
  }

  // Helper to render user details
  async function showUserDetails(userId) {
    detailsBox.innerHTML = '<div class="loading">Loading user...</div>';
    try {
      const res = await fetch(`http://localhost:9999/api/user/id/${userId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          fields: ["Pseudo", "Email", "Img", "Id", "CreatedAt", "LastLogin"]
        })
      });
      const result = await res.json();
      if (result.success && result.data && result.data.user) {
        const u = result.data.user;
        detailsBox.innerHTML = `
          <div class="details-content">
            <img src="${u.Img}" alt="Profile" class="profile-img">
            <div class="title">${u.Pseudo}</div>
            <div class="desc">${u.Email || ""}</div>
            <div class="info-row"><strong>User ID:</strong> ${u.Id}</div>
            <div class="info-row"><strong>Created:</strong> ${u.CreatedAt ? new Date(u.CreatedAt).toLocaleDateString() : "N/A"}</div>
            <div class="info-row"><strong>Last Login:</strong> ${u.LastLogin ? new Date(u.LastLogin).toLocaleString() : "N/A"}</div>
          </div>
        `;
      } else {
        detailsBox.innerHTML = '<div class="error">User not found.</div>';
      }
    } catch {
      detailsBox.innerHTML = '<div class="error">Error loading user.</div>';
    }
  }

  // Keyboard navigation state
  let searchLinks = [];
  let selectedIndex = -1;

  function updateSelection(newIndex) {
    // Remove previous highlight
    searchLinks.forEach(link => link.classList.remove('selected'));
    if (newIndex >= 0 && newIndex < searchLinks.length) {
      searchLinks[newIndex].classList.add('selected');
      // Scroll into view if needed
      searchLinks[newIndex].scrollIntoView({ block: 'nearest' });
      // Show details for the selected item
      const type = searchLinks[newIndex].getAttribute('data-type');
      const id = searchLinks[newIndex].getAttribute('data-id');
      if (type === 'user') showUserDetails(id);
      if (type === 'activity') showActivityDetails(id);
    }
    selectedIndex = newIndex;
  }

  searchInputBox.addEventListener('input', async () => {
    const query = searchInputBox.value.trim();
    resultsDropdown.innerHTML = '';
    detailsBox.innerHTML = '';
    const currentToken = ++_searchToken;
    selectedIndex = -1;
    searchLinks = [];

    if (query) {
      // Fetch players
      const playerPromise = fetch(`http://localhost:9999/api/user/search/${encodeURIComponent(query)}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          fields: ["Pseudo", "Email", "Img", "Id"],
          limit: 10
        })
      }).then(res => res.json());

      // Fetch activities
      const activityPromise = fetch(`http://localhost:9999/api/activity/search/${encodeURIComponent(query)}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          limit: 5,
          fields: ["ID", "Title"],
          levelFields: ["Name"],
          filterFields: ["TypeFilterName"]
        })
      }).then(res => res.json());

      const [playerResult, activityResult] = await Promise.all([playerPromise, activityPromise]);
      if (currentToken !== _searchToken) return;

      // Players
      let players = [];
      if (playerResult.success && Array.isArray(playerResult.data)) {
        players = playerResult.data.slice(0, 3).map(
          user => `<a href="Profile.html?${user.Id}" data-type="user" data-id="${user.Id}">${user.Pseudo}</a>`
        );
      }

      // Activities
      let activities = [];
      if (activityResult.success && Array.isArray(activityResult.data)) {
        activities = activityResult.data.slice(0, 3).map(
          item => `<a href="Activity.html?${item.activity.ID}" data-type="activity" data-id="${item.activity.ID}">${item.activity.Title}</a>`
        );
      }

      let hasResults = false;
      const addCategory = (categoryName, categoryResults) => {
        if (categoryResults && categoryResults.length > 0) {
          hasResults = true;
          const categoryDiv = document.createElement('div');
          categoryDiv.classList.add('dropdown-category');
          const categoryTitle = document.createElement('h3');
          categoryTitle.textContent = categoryName;
          categoryDiv.appendChild(categoryTitle);
          const ul = document.createElement('ul');
          categoryResults.forEach(resultHTML => {
            const li = document.createElement('li');
            li.innerHTML = resultHTML;
            ul.appendChild(li);
          });
          categoryDiv.appendChild(ul);
          resultsDropdown.appendChild(categoryDiv);
        }
      };

      addCategory('Activities', activities);
      addCategory('Teams', []);
      addCategory('Players', players);

      // Add hover listeners for details
      resultsDropdown.querySelectorAll('a[data-type="user"]').forEach(a => {
        a.addEventListener('mouseenter', () => showUserDetails(a.getAttribute('data-id')));
      });
      resultsDropdown.querySelectorAll('a[data-type="activity"]').forEach(a => {
        a.addEventListener('mouseenter', () => showActivityDetails(a.getAttribute('data-id')));
      });

      // Gather all links for keyboard navigation
      searchLinks = Array.from(resultsDropdown.querySelectorAll('a[data-type]'));
      selectedIndex = -1;

      if (hasResults) {
        resultsDropdown.style.display = 'block';
      } else {
        const noResults = document.createElement('div');
        noResults.classList.add('dropdown-no-results');
        noResults.textContent = `No results found for "${query}".`;
        resultsDropdown.appendChild(noResults);
        resultsDropdown.style.display = 'block';
      }
    } else {
      resultsDropdown.style.display = 'none';
      detailsBox.innerHTML = '';
    }
  });

  // Keyboard navigation for search results
  searchInputBox.addEventListener('keydown', function (e) {
    if (!searchLinks.length || resultsDropdown.style.display !== 'block') return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      let nextIndex = selectedIndex + 1;
      if (nextIndex >= searchLinks.length) nextIndex = 0;
      updateSelection(nextIndex);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      let prevIndex = selectedIndex - 1;
      if (prevIndex < 0) prevIndex = searchLinks.length - 1;
      updateSelection(prevIndex);
    } else if (e.key === 'Enter') {
      if (selectedIndex >= 0 && selectedIndex < searchLinks.length) {
        e.preventDefault();
        searchLinks[selectedIndex].click();
      }
    }
  });

  // Mouse click/hover also updates selection
  resultsDropdown.addEventListener('mousemove', function (e) {
    if (e.target.tagName === 'A' && e.target.hasAttribute('data-type')) {
      const idx = searchLinks.indexOf(e.target);
      if (idx !== -1) updateSelection(idx);
    }
  });

  // Also update details on mouseover/focus for accessibility
  resultsDropdown.addEventListener('mouseover', function (e) {
    if (e.target.tagName === 'A' && e.target.hasAttribute('data-type')) {
      const idx = searchLinks.indexOf(e.target);
      if (idx !== -1) updateSelection(idx);
    }
  });
  resultsDropdown.addEventListener('focusin', function (e) {
    if (e.target.tagName === 'A' && e.target.hasAttribute('data-type')) {
      const idx = searchLinks.indexOf(e.target);
      if (idx !== -1) updateSelection(idx);
    }
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (event) => {
    if (!searchContainer.includes && !searchContainer.contains(event.target)) {
      resultsDropdown.style.display = 'none';
      detailsBox.innerHTML = '';
      selectedIndex = -1;
    }
  });

  document.getElementById("fatherland").appendChild(searchPageDiv);
</script>


<style>
  .search-bar-details-wrapper {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    width: 100%;
    min-height: 300px;
    gap: 32px;
  }
  .search-details-box {
    flex: 1 1 480px;
    min-width: 340px;
    max-width: 520px;
    background: var(--bg-dark2);
    color: var(--text);
  
    box-shadow: 0 6px 32px 0 rgba(0,0,0,0.25);
    margin-left: 32px;

    height: 100%;
    min-height: 400px;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: box-shadow 0.2s;
    border: 2px solid var(--accent2);
  }
  .search-details-box:hover {
    box-shadow: 0 12px 48px 0 rgba(0,0,0,0.35);
    border-color: var(--accent);
  }
  .details-content {
    width: 100%;
    text-align: center;
    font-size: 1.1rem;
    padding-top: 8px;
  }
  .details-content .main-img {
    width: 100%;
    max-width: 420px;
    border-radius: 12px;
    margin-bottom: 12px;
    box-shadow: 0 2px 16px 0 rgba(0,0,0,0.18);
    object-fit: cover;
  }
  .details-content .logo-img {
    width: 90px;
    height: 90px;
    object-fit: contain;
    border-radius: 50%;
    background: #222;
    margin: -50px auto 8px auto;
    box-shadow: 0 2px 8px 0 rgba(0,0,0,0.18);
    border: 3px solid var(--accent);
    position: relative;
    z-index: 2;
    display: block;
  }
  .details-content .profile-img {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 50%;
    margin: 0 auto 16px auto;
    box-shadow: 0 2px 12px 0 rgba(0,0,0,0.18);
    border: 3px solid var(--accent2);
    background: #222;
  }
  .details-content .title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 8px;
  }
  .details-content .desc {
    margin-bottom: 18px;
    color: var(--text);
  }
  .details-content .info-row {
    margin-bottom: 8px;
    font-size: 1.05rem;
  }
  .loading, .error {
    color: var(--accent2);
    margin-top: 40px;
    text-align: center;
    font-size: 1.2rem;
  }

  .details-content.activity-details {
  padding: 0;
  background: none;
  border: none;
  box-shadow: none;
}
.activity-image-wrapper {
  position: relative;
  width: 100%;
  margin-bottom: 0;
}
.main-img-activity {
  width: 100%;
  max-width: 100%;
  box-shadow: 0 2px 16px 0 rgba(0,0,0,0.18);
  object-fit: cover;
  display: block;
}
.logo-img-activity {
  position: absolute;
  top: 10%;
  left: 10%;
  width: 80%;
  height: 80%;
  object-fit: contain;
  background: transparent;
  z-index: 2;
  pointer-events: none;
}
.activity-info-section {
  border-top: 2px solid var(--accent2);
  border-bottom: 2px solid var(--accent2);
  padding: 18px 0 18px 0;
  margin-bottom: 0;
  margin-top: 0;
}
.activity-info-section .title {
  font-size: 1.6rem;
  font-weight: bold;
  color: var(--accent);
  margin-bottom: 8px;
}
.activity-info-section .desc {
  color: var(--text);
  margin-bottom: 0;
}
.activity-stats-section {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 18px 0 0 0;
}
.activity-stat-row {
  font-size: 1.2rem;
  color: var(--bold);
  letter-spacing: 0.5px;
}
/* Highlight selected search result */
.search-results-dropdown a.selected {
  background: var(--accent2);
  color: #fff;
  border-radius: 6px;
  outline: none;
}
  </style>
      </script>
    </div>
  </div>
</body>

</html>